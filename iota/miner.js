const Iota = require('iota.lib.js');

// const Curl = require('iota.lib.js/lib/crypto/curl/curl');
const Converter = require('iota.lib.js/lib/crypto/converter/converter');

let iota = new Iota({
    provider: 'http://iota.bitfinex.com:80'
});

// iota.api.getTransactionsObjects(['EBLZCEMRACMXYKRBUWBGVEZHHZDBWJMYOQLXAHHIYQNLMP9UECRVPJKAAYAGBOSNWPIFKWMHAUPUZ9999'], (err, tran) => {
//     console.log('tran', tran);
//     console.log('trytes', iota.utils.transactionTrytes(tran[0]));
// });


// console.log(iota.utils.transactionObject('TCMDTBWCQCQBRCXCYBXCTBBCDCNDSBVAXBXCSBGDSBBDACZARCMBSB9BSBZCDDGCECMBTBCBSATCMDTBUATCGCLB9DSBYCCDXCICQBPBUAHCBCSBGDSBBDTBJDSCGCAC9DSBYCCDXCSCQBPBIDICWALD9DVBGCXBUAHCGCACNDSBXCKDXCHCWACBIDSCQBECIDSCMBSB9BTCMDTBUARCMDSB9BWBCCDCMDWBNDKBZAWBNB9CKDWBNBHCUAWBMBKDXCQCGCWBXCYBXCSBUAWBNBOBWAWBCCOBXCVBMBTBUARCQBUAXCYBYCWBKDVBMBTBUASCBDLBHDSBYCCDLDVBMBTBDDRCQBUAXCYBYCRCZAWBCCDCYAXBYCVCZAXBNBWBLDWBBCKDXCHCGCLBHDSBYCCDKDVBMBTBWCSCBDLBHDSBYCCDKDUCGCUASATCSCUCOBCCECLBPCKDRBGCOBXCOBPCXAVBKBDDXB9BABXCVCNCRBFDLDTCVABDRCBD9DGC9BMDFCSBUCCBIDVATCCBEDJDMBCDXBUAKDBBACTCYARAXARCRBMDQC9BNDFCDCZCOBUA9DCCNDHCHDABUCOB9BZBJDVCAD9D9BYBFDGDICQCSCYCIDUANDBBJDZCRBBDJDPBVCRADCLDJDQBPBMBRBLDXBXCXBBBIDUANBWCXATBLDZAWBUCSCSCGCRCQCKBYBHCPBIDRBVAZCTBQCOBACACRC9BWACDMBWCCCZBGCCDND9BKBBDSCCDYCTBVCABCBTCXCEDTBDCUBDCZARAGCTC9CYCGCICVCUCTBCDHCEDHDNBRAYCHCABLBDCCDYAPCRCNDKBYAYB9BICWCNDBDPCRBZARCRCDDZCDCXCNBGDWAIDFDDDTBTCSBYCOBYBGD9DMDBDHD9CGDRAQCQBWCTBVCACCBSC9CECVBVB9DMBMBECACDDXBVBCDXAZCFDNDDCBBLBMBNCOBYBVAQCNDEDXBAB9DRAZBOBQCNB9DUAUANBWCSCQCJD9CNBQBPBCCMBYCZBOBWCSBSBWCCBHCFDLBTBUBVBDDHDYCRBWCFC9DABADACYBIDCBQCTBVBWAQBWBVCVAUCMDVALDQBNDXCRBPBQBLBOBWBKD99999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999QPM9ZSUPIJKPYFYUWESXLHEKMUJZ9TLBDWUTPZGOMMDAFEFBWXAYBTIEYOAUR9UYEYKQDP9MYQYOBCQLA999999999999999999999999999J99999999999999999999999999OG9ZDYD99999999999999999999I9JJUXQPBSYGINEJCWVFJJWEUPZUPQLWITFVT9CYSDZIRROLXCHVJIATDOFCKIUIQRJLKEVEIDJHKOUVWOSGZVUNNBSUGHDPDIOCKPTOKGGLHQEVVNGERDUDFALL9XQ9VLZBXQUEGSJLDGAFMHXDDGVQBMKOA99999LBFTENY9R9SUZYEATEGXM9IDW99IFFHUO9KZVNBLTSBZMBNAPLBAVMUPUMFBZWQQSKUOXHU9SUDE99999J99999999999999999999999999B9BHUJPKE999999999L99999999Y9ONEEKTKJUGSLDJIINEIVSCTBN'));
// console.log(iota.utils.fromTrytes('ODGABDPCADTCGADBGACCTCGDHD9DCDGAQAGAADTCGDGDPCVCTCGADBGARBPC9D9DCDEAHDWCTCFDTCSAEAVAWAXAYAZAGAQD'))




const NUMBER_OF_ROUNDS = 81;
const HASH_LENGTH = 243;
const STATE_LENGTH = 3 * HASH_LENGTH;
const TRUTH_TABLE = [1, 0, -1, 2, 1, -1, 0, 2, -1, 1, 0];

const NONCE_INDEX_START = 3 * 2646;
const NONCE_LENGTH = 3 * 27;

class Curl {
    constructor(rounds) {
        this.rounds = rounds ? rounds : NUMBER_OF_ROUNDS;
    }

    /**
    *   Initializes the state with STATE_LENGTH trits
    *
    *   @method initialize
    **/
    initialize(state, length) {
        if (state) {
            this.state = state;
        }
        else {
            this.state = new Int8Array(STATE_LENGTH);
        }
    }

    reset() {
        this.initialize();
    }

    /**
    *   Sponge absorb function
    *
    *   @method absorb
    **/
    absorb(trits, offset, length) {
        do {
            var limit = (length < HASH_LENGTH ? length : HASH_LENGTH);

            this.state.set(trits.slice(offset, offset + limit));

            offset += limit;

            this.transform();
        } while ((length -= HASH_LENGTH) > 0);
    }

    /**
    *   Sponge squeeze function
    *
    *   @method squeeze
    **/
    squeeze(trits) {
        return this.state.slice(0, HASH_LENGTH);
    }

    /**
    *   Sponge transform function
    *
    *   @method transform
    **/
    transform() {
        var index = 0;

        for (var round = 0; round < this.rounds; round++) {
            var stateCopy = this.state.slice(0);

            for (var i = 0; i < STATE_LENGTH; i++) {
                var alpha = stateCopy[index];
                var beta = stateCopy[index += (index < 365 ? 364 : -365)] << 2;
                var delta = alpha + beta + 5;

                this.state[i] = TRUTH_TABLE[delta];
            }
        }
    }

    isFound(minWeightMagnitude) {
        for (var i = 0; i < minWeightMagnitude; i++) {
            if (this.state[HASH_LENGTH - 1 - i] !== 0) {
                return false;
            }
        }

        return true;
    }
}

var increments = 0;

function incrementNonce(trits) {
    var start = NONCE_INDEX_START;
    var end = start + NONCE_LENGTH;

    start = Math.floor(Math.random() * (end - start) + start);

    // console.log('start', start, end);
    // console.log('bounds', NONCE_INDEX_START, NONCE_INDEX_START + NONCE_LENGTH);

    for (var i = start; (++trits[i] > 1) && (i < end); i++) {
        trits[i] = -1;
    }

    // console.log('nonce', Converter.trytes(trits.slice(NONCE_INDEX_START, NONCE_INDEX_START + NONCE_LENGTH)));
}






let tx = 'TCMDTBWCQCQBRCXCYBXCTBBCDCNDSBVAXBXCSBGDSBBDACZARCMBSB9BSBZCDDGCECMBTBCBSATCMDTBUATCGCLB9DSBYCCDXCICQBPBUAHCBCSBGDSBBDTBJDSCGCAC9DSBYCCDXCSCQBPBIDICWALD9DVBGCXBUAHCGCACNDSBXCKDXCHCWACBIDSCQBECIDSCMBSB9BTCMDTBUARCMDSB9BWBCCDCMDWBNDKBZAWBNB9CKDWBNBHCUAWBMBKDXCQCGCWBXCYBXCSBUAWBNBOBWAWBCCOBXCVBMBTBUARCQBUAXCYBYCWBKDVBMBTBUASCBDLBHDSBYCCDLDVBMBTBDDRCQBUAXCYBYCRCZAWBCCDCYAXBYCVCZAXBNBWBLDWBBCKDXCHCGCLBHDSBYCCDKDVBMBTBWCSCBDLBHDSBYCCDKDUCGCUASATCSCUCOBCCECLBPCKDRBGCOBXCOBPCXAVBKBDDXB9BABXCVCNCRBFDLDTCVABDRCBD9DGC9BMDFCSBUCCBIDVATCCBEDJDMBCDXBUAKDBBACTCYARAXARCRBMDQC9BNDFCDCZCOBUA9DCCNDHCHDABUCOB9BZBJDVCAD9D9BYBFDGDICQCSCYCIDUANDBBJDZCRBBDJDPBVCRADCLDJDQBPBMBRBLDXBXCXBBBIDUANBWCXATBLDZAWBUCSCSCGCRCQCKBYBHCPBIDRBVAZCTBQCOBACACRC9BWACDMBWCCCZBGCCDND9BKBBDSCCDYCTBVCABCBTCXCEDTBDCUBDCZARAGCTC9CYCGCICVCUCTBCDHCEDHDNBRAYCHCABLBDCCDYAPCRCNDKBYAYB9BICWCNDBDPCRBZARCRCDDZCDCXCNBGDWAIDFDDDTBTCSBYCOBYBGD9DMDBDHD9CGDRAQCQBWCTBVCACCBSC9CECVBVB9DMBMBECACDDXBVBCDXAZCFDNDDCBBLBMBNCOBYBVAQCNDEDXBAB9DRAZBOBQCNB9DUAUANBWCSCQCJD9CNBQBPBCCMBYCZBOBWCSBSBWCCBHCFDLBTBUBVBDDHDYCRBWCFC9DABADACYBIDCBQCTBVBWAQBWBVCVAUCMDVALDQBNDXCRBPBQBLBOBWBKD99999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999QPM9ZSUPIJKPYFYUWESXLHEKMUJZ9TLBDWUTPZGOMMDAFEFBWXAYBTIEYOAUR9UYEYKQDP9MYQYOBCQLA999999999999999999999999999J99999999999999999999999999OG9ZDYD99999999999999999999I9JJUXQPBSYGINEJCWVFJJWEUPZUPQLWITFVT9CYSDZIRROLXCHVJIATDOFCKIUIQRJLKEVEIDJHKOUVWOSGZVUNNBSUGHDPDIOCKPTOKGGLHQEVVNGERDUDFALL9XQ9VLZBXQUEGSJLDGAFMHXDDGVQBMKOA99999LBFTENY9R9SUZYEATEGXM9IDW99IFFHUO9KZVNBLTSBZMBNAPLBAVMUPUMFBZWQQSKUOXHU9SUDE99999J99999999999999999999999999B9BHUJPKE999999999L99999999Y9ONEEKTKJUGSLDJIINEIVSCTBN';
var transactionTrits = Converter.trits(tx);

tx = '999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999DNONPHKKCDBVDZHWALMYRIXLMUIBAUJOVPIKDALHMFNTYZQECNFOECZLLLACHSA9PAKUCGDIREHKMR9FW999999999999999999999999999GDNSPAM9X999999999999999999JHDZDYD99999999999999999999AKHRXLHRCPLJBXLXZNHRJZDCGQKHKH9PCLDCPQHOCCUWEAIUFIJOHZLKXSYLRUPGTWCARKFGK9FHKACXATIXAXGFJJCICVEEIFUTUCIEBECRCZGJOJUDPDJ9SLISKJONGLOYJPVFZF9HCBJNWIKSLNQIHMN9MA9999VIIEHEV9D9SWGJZQPRVPTICMENFDNAEPPABSAZ9MTKDQMS9PHJFRP9EXCCJEPRTRTZDEGTLYIURUA9999DANSPAM9X999999999999999999BDRX9JPKE999999999L99999999QLLBBMFMQWOSSBYZPJKKOPOFBKP';
var transactionTrits1 = Converter.trits(tx);

tx = '999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999VJVRYYGV9IVQNVHFHWDQLYKBPDJVVQGYSSVPOWNJKCQYJWWMOUBMFYUWLCYNUZNOCSJQTFOVYFLQHWFYW999999999999999999999999999VE9999999999999999999999999FKDZDYD99999999999999999999AHAHBLUD9HCOYTUXSBDHBI9GOS9MOBFCTUA9ZVAEEHQZKDOVL9LNCNXIHKCJFFDBFDLRFWGSRWQIDRGBAQZRVTQNNARSDOWPIX9QJTHXYJZLZRUZSU9X9XLBHKZQGJNG999ST9LZLURCVMSQBTPDFCWABFLRJA9999LDTEOVPTVSUSANGGMENUSPWTLUAQTVMZFT9EUXWVPBQQFZIYXFBSZUZIJNDRPAD9LO99YNASKIEWA9999999999999999999999999999999BRQA9JPKE999999999MMMMMMMMM999999999999999999999999999';
var transactionTrits2 = Converter.trits(tx);

// tx = '999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999HDHAXCPSXGARHNXSVALOUPV9ZDJECZYWRZBOTUBZNAMODQDHRXTHJAZSWFFADSVIGSOTRARURNZMVNKND999999999999999999999999999C99999999999999999999999999MMDZDYD99999999999999999999TCWGSDXZCULISINCBJLQEWTAUEL9GCFWLKTFCSFCDZXRRQJFZUAWDOEKPHLBXXFVHWIQJGISCBONUKAYWOHJIMYCCFNQEZSFAWJASFVIDRXSCVJDAAKXSMNMXEAZVSXRKKCQLMAFXEWALMTXGURLAOQRYVTVG99999ETCVTYTMDAVTEXMJDLUOSGTWLGEQEASAFOKTQRTPPDBNNRPQPRTPUYAJ99BOOGLVHXOKJPNRKEDYA9999999999999999999999999999999PGUD9JPKE999999999MMMMMMMMMPA999IK99999999999999999999';
// var transactionTrits3 = Converter.trits(tx);

// console.log('nonce', tx.slice(2646, 2673));
// console.log('nonce tri', JSON.stringify(transactionTrits2.slice(2646 * 3, 2673 * 3)));

// console.log('nonce conv', JSON.stringify(Converter.trits(tx.slice(2646, 2673))));

function testCurl(trits) {
    var curl = new Curl();
    var hash = [];

    curl.initialize();
    curl.absorb(trits, 0, trits.length);

    while (!curl.isFound(8)) {
        incrementNonce(trits);

        curl.reset();
        curl.absorb(trits, 0, trits.length);
    }

    console.log('hash', curl.isFound(14), Converter.trytes(curl.squeeze()));
}

var start = Date.now();

// testCurl(transactionTrits);
// testCurl(transactionTrits1);
testCurl(transactionTrits2);
// testCurl(transactionTrits3);

console.log('time', (Date.now() - start));
